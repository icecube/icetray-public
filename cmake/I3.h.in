/**
 *  $Id$
 *  
 *  Copyright (C) 2004, 2005, 2006, 2007
 *  Troy D. Straszheim  <troy@icecube.umd.edu>
 *  and the IceCube Collaboration <http://www.icecube.wisc.edu>
 *  
 *  This file is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 3 of the License, or
 *  (at your option) any later version.
 *  
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *  
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>
 *  
 */
#ifndef __CINT__
#  include <pyconfig.h>
#  ifdef __APPLE_CC__
#    ifdef _POSIX_C_SOURCE
#      undef _POSIX_C_SOURCE
#    endif
#  endif
#endif

#ifdef __cplusplus

#ifndef ICETRAY_I3_H_INCLUDED
#define ICETRAY_I3_H_INCLUDED

#include <I3/intel_compatibility.h>
//
//  Preprocessor def is set if we're building python bindings.  
//
#ifdef I3_PYBINDINGS_MODULE

// this has to match the type of libs you link to.  This should
// probably be configured by the boost tool and put on the command
// line instead of done here.
#if BOOST_VERSION < 103800
#define BOOST_DISABLE_THREADS
#endif

#define BOOST_PYTHON_DYNAMIC_LIB

#include <boost/python.hpp>
#include <boost/python/suite/indexing/indexing_suite.hpp>
#include <boost/python/suite/indexing/map_indexing_suite.hpp>
#include <boost/python/suite/indexing/vector_indexing_suite.hpp>

#include "container_conversions.h"
using scitbx::boost_python::container_conversions::from_python_sequence;
using scitbx::boost_python::container_conversions::to_tuple;
using scitbx::boost_python::container_conversions::variable_capacity_policy;

#endif // I3_PYBINDINGS_MODULE


// e.g. gcc 3.4.6 -> 30406
#define GCC_VERSION (__GNUC__ * 10000 + __GNUC_MINOR__ * 100 + __GNUC_PATCHLEVEL__)

#if GCC_VERSION < 30400
#error gcc < 3.4 is not supported.  Please use gcc 3.4.x or newer.
#endif

#if 0
#if (GCC_VERSION >= 30400)
#define DSOLOCAL __attribute__ ((visibility ("hidden")))
#define DSOEXPORT __attribute__ ((visibility ("default")))
#endif
#else
#define DSOLOCAL
#define DSOEXPORT
#endif

#ifdef I3_USE_FAST_OMKEY_MAP
#define BOOST_STD_EXTENSION_NAMESPACE __gnu_cxx
#endif

#ifdef __APPLE_CC__
#  define _GLIBCPP_USE_C99 1
#  define _GLIBCXX_USE_C99 1
#  define M_PIl          3.1415926535897932384626433832795029L  /* pi */
#else
#  define HAVE_STRNLEN 1
#endif

// gives us the tasty bits like INT32_MAX
#define __STDC_LIMIT_MACROS

#include <cmath>
#include <math.h>
using std::isnan;

// Threading causes wierd lockups in various places as ROOT fights
// with Java and whatever else.
#define BOOST_NO_WREGEX

#ifdef I3_OPTIMIZE
#define BOOST_DISABLE_ASSERTS
#endif

#include <boost/version.hpp>


#include <boost/shared_ptr.hpp>
using boost::shared_ptr;
using boost::dynamic_pointer_cast;

// workaround for braindead rootcint.  doesn't recognize the using
// boost::shared_ptr.  I can just see this popping up to cause us
// unspeakable aggravation in the future...

#ifdef __CINT__
template <typename T>
struct shared_ptr : boost::shared_ptr<T> { };

#include "TError.h"
#include "zlib.h"

#endif

#ifdef I3_PYBINDINGS_MODULE

#include <icetray/I3FrameObject.h>
#include <I3/name_of.h>

//
// Tell python about basic conversions to/from const and FrameObject pointers
//
template <typename T>
void
register_pointer_conversions()
{
  using boost::python::implicitly_convertible;

  implicitly_convertible<shared_ptr<T>, shared_ptr<I3FrameObject> >();
  implicitly_convertible<shared_ptr<T>, shared_ptr<const T> >();
  implicitly_convertible<shared_ptr<T>, shared_ptr<const I3FrameObject> >();

  //  implicitly_convertible<shared_ptr<I3FrameObject>, shared_ptr<T> >();
  //  implicitly_convertible<shared_ptr<const I3FrameObject>, shared_ptr<const T> >();
  //  boost::python::register_ptr_to_python<boost::shared_ptr<T> >();
}

template <typename T> 
T 
identity_(T t) { return t; }


//
//  macros for general use
//
// GETSET implementation.  Pass the name of the Type, 
// the name of the member to access via Get*** Set***,
// and the return value policy.
// Used by the two macros below
#define GETSET_IMPL(ObjType, GotType, Name, CallPolicies)		\
  .def("Get" BOOST_PP_STRINGIZE(Name),					\
       (GotType (ObjType::*) ()) &ObjType:: Get##Name,			\
       CallPolicies)							\
  .def("Set" BOOST_PP_STRINGIZE(Name),					\
       &ObjType::Set##Name)

// This is for member functions that return a Whatever&,
// where the actual Whatever is owned by the class.
#define GETSET_INTERNAL_REFERENCE(ObjType, GotType, Name)		\
  GETSET_IMPL(ObjType, GotType, Name, return_internal_reference<1>())

// This is for getters and setters that return PODS by value
#define GETSET(Objtype, GotType, Name)			\
  GETSET_IMPL(Objtype, GotType, Name, default_call_policies())

#define PROPERTY(Class, Prop, Fn) .add_property(BOOST_PP_STRINGIZE(Prop), &Class::Get##Fn, &Class::Set##Fn)

#endif

#endif // ICETRAY_I3_H_INCLUDED
#endif // __cplusplus

